var GolemCacheMecha={version:"1.0.0",options:{debug:!1,localCacheFolder:"golemCacheMecha",useDataURI:!1,chromeQuota:10485760,usePersistentCache:!0,cacheClearSize:0,headers:{},withCredentials:!1,skipURIencoding:!1,androidFilesystemRoot:null,timeout:0,brokenImageHandler:!0},overridables:{hash:function(e){function a(e,a,o){for(;0<o--;)e.push(a)}function o(e,a){return e<<a|e>>>32-a}function t(e,a,o){return e^a^o}function r(e,a){var o=(65535&a)+(65535&e);return(65535&(a>>>16)+(e>>>16)+(o>>>16))<<16|65535&o}var i="0123456789abcdef";return function(e){for(var a,o=[],t=4*e.length,r=0;r<t;r+=1)a=e[r>>2]>>8*(3-r%4),o.push(i.charAt(a>>4&15)+i.charAt(15&a));return o.join("")}(function(e,i){var c,n,l,s,h,d=e.length,u=1732584193,m=4023233417,f=2562383102,g=271733878,C=3285377520,L=[];a(L,1518500249,20),a(L,1859775393,20),a(L,2400959708,20),a(L,3395469782,20),e[i>>5]|=128<<24-i%32,e[15+(i+65>>9<<4)]=i;for(var v=0;v<d;v+=16){c=u,n=m,l=f,s=g,h=C;for(var G=0,E=[];G<80;G+=1){E[G]=G<16?e[G+v]:o(E[G-3]^E[G-8]^E[G-14]^E[G-16],1);var M=function(e,a,o,t,r){var i=(65535&r)+(65535&e)+(65535&a)+(65535&o)+(65535&t);return(65535&(r>>>16)+(e>>>16)+(a>>>16)+(o>>>16)+(t>>>16)+(i>>>16))<<16|65535&i}(G<20?n&l^~n&s:G<40?t(n,l,s):G<60?n&l^n&s^l&s:t(n,l,s),h,L[G],E[G],o(c,5));h=s,s=l,l=o(n,30),n=c,c=M}u=r(u,c),m=r(m,n),f=r(f,l),g=r(g,s),C=r(C,h)}return[u,m,f,g,C]}(function(e){for(var a=[],o=8*e.length,t=0;t<o;t+=8)a[t>>5]|=(255&e.charCodeAt(t/8))<<24-t%32;return a}(e).slice(),8*e.length))},log:function(e,a){"use strict";GolemCacheMecha.options.debug&&(a===LOG_LEVEL_INFO&&(e="INFO: "+e),a===LOG_LEVEL_WARNING&&(e="WARN: "+e),a===LOG_LEVEL_ERROR&&(e="ERROR: "+e),console.log(e))}},ready:!1,attributes:{}},LOG_LEVEL_INFO=1,LOG_LEVEL_WARNING=2,LOG_LEVEL_ERROR=3;!function(e){"use strict";var a={sanitizeURI:function(e){return GolemCacheMecha.options.skipURIencoding?e:(e.length>=2&&'"'===e[0]&&'"'===e[e.length-1]&&(e=e.substr(1,e.length-2)),encodeURI(e))},URI:function(e){e||(e="");var a=e.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);this.scheme=a[1]||null,this.authority=a[2]||null,this.path=a[3]||null,this.query=a[4]||null,this.fragment=a[5]||null},URIGetFileName:function(e){if(e){var a=e.lastIndexOf("/");if(a)return e.substr(a+1).toLowerCase()}},URIGetPath:function(e){if(e)return a.URI(e).path.toLowerCase()},fileGetExtension:function(e){if(!e)return"";var a=(e=e.split("?")[0]).split(".").pop();return!a||a.length>4?"":a},appendPaths:function(e,a){return a||(a=""),e&&""!==e?e+("/"==e[e.length-1]||a.length>0&&"/"==a[0]?"":"/")+a:(a.length>0&&"/"==a[0]?"":"/")+a},hasJqueryOrJqueryLite:function(){return GolemCacheMecha.jQuery||GolemCacheMecha.jQueryLite},isCordova:function(){return("undefined"!=typeof cordova||"undefined"!=typeof phonegap)&&"browser"!==(cordova||phonegap).platformId},isCordovaAndroid:function(){return a.isCordova()&&device&&device.platform&&device.platform.toLowerCase().indexOf("android")>=0},isCordovaWindowsPhone:function(){return a.isCordova()&&device&&device.platform&&(device.platform.toLowerCase().indexOf("win32nt")>=0||device.platform.toLowerCase().indexOf("windows")>=0)},isCordovaIOS:function(){return a.isCordova()&&device&&device.platform&&"ios"===device.platform.toLowerCase()},isCordovaAndroidOlderThan3_3:function(){return a.isCordovaAndroid()&&device.version&&(0===device.version.indexOf("2.")||0===device.version.indexOf("3.0")||0===device.version.indexOf("3.1")||0===device.version.indexOf("3.2"))},isCordovaAndroidOlderThan4:function(){return a.isCordovaAndroid()&&device.version&&(0===device.version.indexOf("2.")||0===device.version.indexOf("3."))},EntryToURL:function(e){return a.isCordovaAndroidOlderThan4()&&"function"==typeof e.toNativeURL?e.toNativeURL():"function"==typeof e.toInternalURL?e.toInternalURL():e.toURL()},EntryGetURL:function(e){return"function"==typeof e.toURL?a.EntryToURL(e):e.toURI()},EntryGetPath:function(e){return a.isCordova()?a.isCordovaIOS()?a.isCordovaAndroidOlderThan3_3()?e.fullPath:e.nativeURL:"function"==typeof e.toURL?a.EntryToURL(e):e.fullPath:e.fullPath},getCordovaStorageType:function(e){if("undefined"!=typeof LocalFileSystem){if(e&&LocalFileSystem.hasOwnProperty("PERSISTENT"))return LocalFileSystem.PERSISTENT;if(!e&&LocalFileSystem.hasOwnProperty("TEMPORARY"))return LocalFileSystem.TEMPORARY}return e?window.PERSISTENT:window.TEMPORARY}},o={trigger:function(o,t){GolemCacheMecha.jQuery?e(o).trigger(t):(!a.isCordovaWindowsPhone()&&window.CustomEvent||(window.CustomEvent=function(e,a){var o;a=a||{bubbles:!1,cancelable:!1,detail:void 0};try{(o=document.createEvent("CustomEvent")).initCustomEvent(e,a.bubbles,a.cancelable,a.detail)}catch(t){(o=document.createEvent("Event")).initEvent(e,a.bubbles,a.cancelable),o.detail=a.detail}return o}),o.dispatchEvent(new CustomEvent(t)))},removeAttribute:function(e,o){a.hasJqueryOrJqueryLite()?e.removeAttr(o):e.removeAttribute(o)},setAttribute:function(e,o,t){a.hasJqueryOrJqueryLite()?e.attr(o,t):e.setAttribute(o,t)},getAttribute:function(e,o){return a.hasJqueryOrJqueryLite()?e.attr(o):e.getAttribute(o)},getBackgroundImage:function(e){if(a.hasJqueryOrJqueryLite())return e.attr("data-old-background")?"url("+e.attr("data-old-background")+")":e.css("background-image");var o=window.getComputedStyle(e,null);return o?e.getAttribute("data-old-background")?"url("+e.getAttribute("data-old-background")+")":o.backgroundImage:void 0},setBackgroundImage:function(e,o){a.hasJqueryOrJqueryLite()?e.css("background-image",o):e.style.backgroundImage=o}},t={attributes:{},isImgCacheLoaded:function(){return!(!GolemCacheMecha.attributes.filesystem||!GolemCacheMecha.attributes.dirEntry)||(GolemCacheMecha.overridables.log("GolemCacheMecha not loaded yet! - Have you called GolemCacheMecha.init() first?",LOG_LEVEL_WARNING),!1)}};t.attributes.hasLocalStorage=!1,t.hasLocalStorage=function(){if(t.attributes.hasLocalStorage)return t.attributes.hasLocalStorage;try{var e=GolemCacheMecha.overridables.hash("imgcache_test");return localStorage.setItem(e,e),localStorage.removeItem(e),t.attributes.hasLocalStorage=!0,!0}catch(e){return GolemCacheMecha.overridables.log("Could not write to local storage: "+e.message,LOG_LEVEL_INFO),!1}},t.setCurrentSize=function(e){GolemCacheMecha.overridables.log("current size: "+e,LOG_LEVEL_INFO),t.hasLocalStorage()&&localStorage.setItem("golemCacheMecha:"+GolemCacheMecha.options.localCacheFolder,e)},t.getCachedFilePath=function(e){return a.appendPaths(GolemCacheMecha.options.localCacheFolder,t.getCachedFileName(e))},t.getCachedFileFullPath=function(e){var o=a.EntryGetPath(GolemCacheMecha.attributes.dirEntry);return a.appendPaths(o,t.getCachedFileName(e))},t.getCachedFileName=function(e){if(e){var o=GolemCacheMecha.overridables.hash(e),t=a.fileGetExtension(a.URIGetFileName(e));return o+(t?"."+t:"")}GolemCacheMecha.overridables.log("No source given to getCachedFileName",LOG_LEVEL_WARNING)},t.setNewImgPath=function(e,a,t){o.setAttribute(e,"src",a),o.setAttribute(e,r,t)},t.createCacheDir=function(e,t){if(!GolemCacheMecha.attributes.filesystem)return GolemCacheMecha.overridables.log("Filesystem instance was not initialised",LOG_LEVEL_ERROR),void(t&&t());var r=function(e){GolemCacheMecha.overridables.log("Failed to get/create local cache directory: "+e.code,LOG_LEVEL_ERROR),t&&t()};GolemCacheMecha.attributes.filesystem.root.getDirectory(GolemCacheMecha.options.localCacheFolder,{create:!0,exclusive:!1},function(t){GolemCacheMecha.attributes.dirEntry=t,GolemCacheMecha.overridables.log("Store assets to folder: "+a.EntryGetPath(t),LOG_LEVEL_INFO),a.isCordovaAndroid()?t.getFile(".nomedia",{create:!0,exclusive:!1},function(){GolemCacheMecha.overridables.log(".nomedia file created.",LOG_LEVEL_INFO),e&&e()},r):a.isCordovaWindowsPhone()?e&&e():(a.isCordovaIOS()&&t.setMetadata&&t.setMetadata(function(){GolemCacheMecha.overridables.log("com.apple.MobileBackup metadata set",LOG_LEVEL_INFO)},function(){GolemCacheMecha.overridables.log("com.apple.MobileBackup metadata could not be set",LOG_LEVEL_WARNING)},{"com.apple.MobileBackup":1}),e&&e());GolemCacheMecha.ready=!0,o.trigger(document,c)},r)},t.FileTransferWrapper=function(e){a.isCordova()&&(this.fileTransfer=new FileTransfer),this.filesystem=e},t.FileTransferWrapper.prototype.download=function(e,a,o,t,r){var i=GolemCacheMecha.options.headers||{},c="function"==typeof r;if(this.fileTransfer)return c&&(this.fileTransfer.onprogress=r),this.fileTransfer.download(e,a,o,t,!1,{headers:i});var n=this.filesystem,l=function(o,t,r){GolemCacheMecha.overridables.log(o,t),r&&r({code:0,source:e,target:a})},s=new XMLHttpRequest;for(var h in s.open("GET",e,!0),c&&(s.onprogress=r),GolemCacheMecha.options.withCredentials&&(s.withCredentials=!0),s.timeout=GolemCacheMecha.options.timeout,s.responseType="blob",i)s.setRequestHeader(h,i[h]);s.onload=function(){!s.response||200!==s.status&&0!==s.status?l("Image "+e+" could not be downloaded - status: "+s.status,3,t):n.root.getFile(a,{create:!0},function(e){e.createWriter(function(a){a.onerror=t,a.onwriteend=function(){o(e)},a.write(s.response,t)},t)},t)},s.onerror=function(){l("XHR error - Image "+e+" could not be downloaded - status: "+s.status,3,t)},s.ontimeout=function(){l("XHR error - Image "+e+" timed out - status: "+s.status,3,t)},s.send()},t.getBackgroundImageURL=function(e){var a=o.getBackgroundImage(e);if(a){return/url\s?\((.+)\)/.exec(a)[1].replace(/(['"])/g,"")}},t.getBase64DataFromEntry=function(e,a,o,t){e.file(function(e){var r=new FileReader;r.onloadend=function(e){var r=e.target.result;r?(GolemCacheMecha.overridables.log("File "+a+" loaded from cache",LOG_LEVEL_INFO),o&&o(r)):(GolemCacheMecha.overridables.log("File in cache "+a+" is empty",LOG_LEVEL_WARNING),t&&t(a))},r.readAsDataURL(e)},function(e){GolemCacheMecha.overridables.log("Failed to read file "+e.code,LOG_LEVEL_ERROR),t&&t(a)})},t.loadCachedFile=function(e,o,r,i,c){if(t.isImgCacheLoaded())if(e){var n=a.URIGetFileName(o);GolemCacheMecha.attributes.filesystem.root.getFile(t.getCachedFilePath(o),{create:!1},function(l){if(GolemCacheMecha.options.useDataURI)t.getBase64DataFromEntry(l,n,function(a){r(e,a,o),i&&i(e)},function(){c&&c(e)});else{var s=a.EntryGetURL(l);r(e,s,o),GolemCacheMecha.overridables.log("File "+n+" loaded from cache",LOG_LEVEL_INFO),i&&i(e)}},function(){GolemCacheMecha.overridables.log("File "+n+" not in cache",LOG_LEVEL_INFO),c&&c(e)})}else GolemCacheMecha.overridables.log("First parameter of loadCachedFile is empty, should be a DOM element",LOG_LEVEL_ERROR)},t.setBackgroundImagePath=function(e,a,t){o.setBackgroundImage(e,'url("'+a+'")'),o.setAttribute(e,i,t)};var r="data-old-src",i="data-old-background",c="ImgCacheReady";GolemCacheMecha.init=function(e,o){GolemCacheMecha.jQuery=!(!window.jQuery&&!window.Zepto),GolemCacheMecha.jQueryLite=!(void 0===window.angular||!window.angular.element),GolemCacheMecha.attributes.init_callback=e,GolemCacheMecha.overridables.log("GolemCacheMecha initialising",LOG_LEVEL_INFO);var r=function(e){GolemCacheMecha.overridables.log("`LocalFileSystem` service opened",LOG_LEVEL_INFO),GolemCacheMecha.attributes.filesystem=e,t.createCacheDir(function(){var e;e=GolemCacheMecha.attributes.init_callback,GolemCacheMecha.options.cacheClearSize>0&&GolemCacheMecha.getCurrentSize()>1024*GolemCacheMecha.options.cacheClearSize*1024?GolemCacheMecha.clearCache(e,e):e&&e()},o)},i=function(e){GolemCacheMecha.overridables.log("Failed to initialise LocalFileSystem "+e.code,LOG_LEVEL_ERROR),o&&o()};if(a.isCordova()&&window.requestFileSystem)if(GolemCacheMecha.options.androidFilesystemRoot)try{window.resolveLocalFileSystemURL(GolemCacheMecha.options.androidFilesystemRoot,function(e){r({root:e})},i)}catch(e){i({code:e.message})}else window.requestFileSystem(a.getCordovaStorageType(GolemCacheMecha.options.usePersistentCache),0,r,i);else{var c=window.requestFileSystem||window.webkitRequestFileSystem;if(window.storageInfo=window.storageInfo||(GolemCacheMecha.options.usePersistentCache?navigator.webkitPersistentStorage:navigator.webkitTemporaryStorage),!window.storageInfo)return GolemCacheMecha.overridables.log("Your browser does not support to use this caching mechanism!",LOG_LEVEL_WARNING),void(o&&o());var n=GolemCacheMecha.options.chromeQuota;window.storageInfo.requestQuota(n,function(){var e=GolemCacheMecha.options.usePersistentCache?window.PERSISTENT:window.TEMPORARY;c(e,n,r,i)},function(e){GolemCacheMecha.overridables.log("Failed to request quota: "+e.message,LOG_LEVEL_ERROR),o&&o()});var l=function(e){if(e&&e.nodeName&&"IMG"==e.nodeName){var a=new Image;a.onerror=function(){console.log("INFO: Broken image found! Masking with dummy image."),e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWP4//8/AwAI/AL+hc2rNAAAAABJRU5ErkJggg=="},a.src=e.src}else{console.log("INFO: Sanitizing images");var o=document.getElementsByTagName("IMG"),t=o.length;if(t)for(;t--;)l(o[t])}};l()}},GolemCacheMecha.getCurrentSize=function(){if(t.hasLocalStorage()){var e=localStorage.getItem("golemCacheMecha:"+GolemCacheMecha.options.localCacheFolder);return null===e?0:parseInt(e,10)}return 0},GolemCacheMecha.cacheFile=function(e,o,r,i){if(t.isImgCacheLoaded()&&e){e=a.sanitizeURI(e);var c=t.getCachedFileFullPath(e);new t.FileTransferWrapper(GolemCacheMecha.attributes.filesystem).download(e,c,function(e){e.getMetadata(function(e){e&&"size"in e?(GolemCacheMecha.overridables.log("Cached file size: "+e.size,LOG_LEVEL_INFO),t.setCurrentSize(GolemCacheMecha.getCurrentSize()+parseInt(e.size,10))):GolemCacheMecha.overridables.log("No metadata size property available",LOG_LEVEL_INFO)}),GolemCacheMecha.overridables.log("Download complete: "+a.EntryGetPath(e),LOG_LEVEL_INFO),e.setMetadata&&e.setMetadata(function(){GolemCacheMecha.overridables.log("com.apple.MobileBackup metadata set",LOG_LEVEL_INFO)},function(){GolemCacheMecha.overridables.log("com.apple.MobileBackup metadata could not be set",LOG_LEVEL_WARNING)},{"com.apple.MobileBackup":1}),o&&o(e.toURL())},function(e){e.source&&GolemCacheMecha.overridables.log("Download error source: "+e.source,LOG_LEVEL_ERROR),e.target&&GolemCacheMecha.overridables.log("Download error target: "+e.target,LOG_LEVEL_ERROR),GolemCacheMecha.overridables.log("Download error code: "+e.code,LOG_LEVEL_ERROR),r&&r()},i)}},GolemCacheMecha.getCachedFile=function(e,o){if(t.isImgCacheLoaded()&&o){var r=e;e=a.sanitizeURI(e);var i=t.getCachedFilePath(e);a.isCordovaAndroid()&&0===i.indexOf("file://")&&(i=i.substr(7)),GolemCacheMecha.attributes.filesystem.root.getFile(i,{create:!1},function(a){o(e,a)},function(){o(r,null)})}},GolemCacheMecha.getCachedFileURL=function(e,o,t){GolemCacheMecha.getCachedFile(e,function(e,r){r?o(e,a.EntryGetURL(r)):t&&t(e)})},GolemCacheMecha.getCachedFileBase64Data=function(e,a,o){GolemCacheMecha.getCachedFile(e,function(e,r){r?t.getBase64DataFromEntry(r,e,function(o){a(e,o)},o):o&&o(e)})},GolemCacheMecha.isCached=function(e,a){GolemCacheMecha.getCachedFile(e,function(e,o){a(e,null!==o)})},GolemCacheMecha.useOnlineFile=function(e){if(t.isImgCacheLoaded()&&e){var a=o.getAttribute(e,r);a&&o.setAttribute(e,"src",a),o.removeAttribute(e,r)}},GolemCacheMecha.useCachedFile=function(e,r,i){if(t.isImgCacheLoaded()){var c=a.sanitizeURI(o.getAttribute(e,"src"));t.loadCachedFile(e,c,t.setNewImgPath,r,i)}},GolemCacheMecha.useCachedFileWithSource=function(e,o,r,i){if(t.isImgCacheLoaded()){var c=a.sanitizeURI(o);t.loadCachedFile(e,c,t.setNewImgPath,r,i)}},GolemCacheMecha.clearCache=function(e,a){t.isImgCacheLoaded()&&GolemCacheMecha.attributes.dirEntry.removeRecursively(function(){GolemCacheMecha.overridables.log("Local cache cleared",LOG_LEVEL_INFO),t.setCurrentSize(0),t.createCacheDir(e,a)},function(e){GolemCacheMecha.overridables.log("Failed to remove directory or its contents: "+e.code,LOG_LEVEL_ERROR),a&&a()})},GolemCacheMecha.removeFile=function(e,o,r){e=a.sanitizeURI(e);var i=t.getCachedFilePath(e),c=function(e){GolemCacheMecha.overridables.log("Failed to remove file due to "+e.code,LOG_LEVEL_ERROR),r&&r()};GolemCacheMecha.attributes.filesystem.root.getFile(i,{create:!1},function(e){e.remove(function(){o&&o()},c)},c)},GolemCacheMecha.isBackgroundCached=function(e,a){var o=t.getBackgroundImageURL(e);GolemCacheMecha.getCachedFile(o,function(e,o){a(e,null!==o)})},GolemCacheMecha.cacheBackground=function(e,a,o,r){if(t.isImgCacheLoaded()){var i=t.getBackgroundImageURL(e);if(!i)return GolemCacheMecha.overridables.log("No background to cache",LOG_LEVEL_WARNING),void(o&&o());GolemCacheMecha.overridables.log("Background image URL: "+i,LOG_LEVEL_INFO),GolemCacheMecha.cacheFile(i,a,o,r)}},GolemCacheMecha.useCachedBackground=function(e,a,o){if(t.isImgCacheLoaded()){var r=t.getBackgroundImageURL(e);if(!r)return GolemCacheMecha.overridables.log("No background to cache",LOG_LEVEL_WARNING),void(o&&o());t.loadCachedFile(e,r,t.setBackgroundImagePath,a,o)}},GolemCacheMecha.useCachedBackgroundWithSource=function(e,a,o,r){t.isImgCacheLoaded()&&t.loadCachedFile(e,a,t.setBackgroundImagePath,o,r)},GolemCacheMecha.useBackgroundOnlineFile=function(e){if(e){var a=o.getAttribute(e,i);a&&o.setBackgroundImage(e,'url("'+a+'")'),o.removeAttribute(e,i)}},GolemCacheMecha.getCacheFolderURI=function(){if(t.isImgCacheLoaded())return a.EntryGetURL(GolemCacheMecha.attributes.dirEntry)},GolemCacheMecha.helpers=a,GolemCacheMecha.domHelpers=o,GolemCacheMecha.private=t,"function"==typeof define&&define.amd?define("golemCacheMecha",[],function(){return GolemCacheMecha}):"object"==typeof module&&module.exports?module.exports=GolemCacheMecha:window.GolemCacheMecha=GolemCacheMecha}(window.jQuery||window.Zepto||function(){throw"ERR: require jQuery to use for `$img` (will fix with Polyfill in the future)"});
